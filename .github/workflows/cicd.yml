name: The CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]  # GitOps: push a tag to trigger release
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., 1.0.1) - Leave empty for RC build'
        required: false
        type: string
      rollback_to:
        description: 'Rollback to commit SHA (full or short) - Overrides release_version'
        required: false
        type: string

jobs:
  CICD:
    runs-on: ubuntu-latest
    environment: CLOUDFLARE_THESLOPE
    outputs:
      deployed_env: ${{ steps.target.outputs.env }}
      deployed_url: ${{ steps.deploy.outputs.url }}
      release_version: ${{ steps.version.outputs.RELEASE_VERSION }}
      release_date: ${{ steps.version.outputs.RELEASE_DATE }}
      is_release: ${{ steps.version.outputs.IS_RELEASE }}

    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      HEY_NABO_USERNAME: ${{ secrets.HEY_NABO_USERNAME }}
      HEY_NABO_PASSWORD: ${{ secrets.HEY_NABO_PASSWORD }}
      HEY_NABO_EJ_ADMIN_USERNAME: ${{ secrets.HEY_NABO_EJ_ADMIN_USERNAME }}
      NUXT_PUBLIC_HEY_NABO_API: ${{ vars.NUXT_PUBLIC_HEY_NABO_API }}
      DB_D1_NAME: ${{ vars.DB_D1_NAME }}
      DB_D1_ID: ${{ secrets.DB_D1_ID }}
      NUXT_SESSION_PASSWORD: ${{ secrets.NUXT_SESSION_PASSWORD }}
      CI: true

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for version calculation
          ref: ${{ inputs.rollback_to || github.sha }}
      - run: ls -la
      - uses: actions/setup-node@v5
        with:
          node-version-file: 'package.json'
      - run: npm ci
      - name: Calculate version
        id: version
        run: |
          if [ -n "${{ inputs.rollback_to }}" ]; then
            echo "ðŸ”„ Rollback mode to commit: ${{ inputs.rollback_to }}"
            RELEASE_VERSION="" make version-info >> $GITHUB_OUTPUT
          elif [ -n "${{ inputs.release_version }}" ]; then
            echo "ðŸŽ‰ Release mode (workflow_dispatch): ${{ inputs.release_version }}"
            RELEASE_VERSION="${{ inputs.release_version }}" make version-info >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG_VERSION="${{ github.ref_name }}"
            TAG_VERSION="${TAG_VERSION#v}"  # Strip 'v' prefix
            echo "ðŸ·ï¸ Release mode (git tag): $TAG_VERSION"
            RELEASE_VERSION="$TAG_VERSION" make version-info >> $GITHUB_OUTPUT
          else
            echo "ðŸ”¨ RC build mode"
            RELEASE_VERSION="" make version-info >> $GITHUB_OUTPUT
          fi
          cat $GITHUB_OUTPUT
      - name: Linting
        run: npm run lint
      - run: npx prisma validate
      - name: Run unit tests
        run: npm run test:unit
      - name: Install Playwright and browser friends
        run: npx playwright install chromium
      - name: Prepare local D1 database for testing
        run: |
          npm run db:migrate:local
          npm run db:seed:local
          npx wrangler d1 execute theslope --command="SELECT * FROM User" --local
      - name: Run e2e api tests
        run: npm run test:e2e:api
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-api
          path: playwright-report/
          retention-days: 30
      - name: Run e2e ui tests
        run: npm run test:e2e:ui
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-ui
          path: playwright-report/
          retention-days: 30
      - name: Determine deployment target
        id: target
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "env=prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Tag push: check if tagged commit is on main branch
            if git branch -r --contains HEAD | grep -q 'origin/main'; then
              echo "ðŸ·ï¸ Tag on main branch â†’ prod"
              echo "env=prod" >> $GITHUB_OUTPUT
            else
              echo "ðŸ·ï¸ Tag NOT on main branch â†’ dev"
              echo "env=dev" >> $GITHUB_OUTPUT
            fi
          else
            echo "env=dev" >> $GITHUB_OUTPUT
          fi
      - name: Deploy to Cloudflare
        id: deploy
        env:
          NUXT_PUBLIC_RELEASE_VERSION: ${{ steps.version.outputs.RELEASE_VERSION }}
          NUXT_PUBLIC_RELEASE_DATE: ${{ steps.version.outputs.RELEASE_DATE }}
          GITHUB_SHA: ${{ steps.version.outputs.COMMIT_SHA }}
        run: |
          if [ "${{ steps.target.outputs.env }}" == "prod" ]; then
            OUTPUT=$(make deploy-prod 2>&1)
          else
            OUTPUT=$(make deploy-dev 2>&1)
          fi
          echo "$OUTPUT"
          echo "url=$(echo "$OUTPUT" | grep 'DEPLOY_URL' | grep -oE 'https://[^")]+')" >> $GITHUB_OUTPUT
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployed to ${{ steps.target.outputs.env }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`${{ steps.target.outputs.env }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ steps.version.outputs.RELEASE_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Release Date** | ${{ steps.version.outputs.RELEASE_DATE }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Is Release** | ${{ steps.version.outputs.IS_RELEASE }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | ${{ steps.deploy.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit Message** | ${{ github.event.head_commit.message }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **PR Title** | ${{ github.event.pull_request.title }} |" >> $GITHUB_STEP_SUMMARY

  create-release:
    needs: CICD
    if: needs.CICD.outputs.is_release == 'true' && needs.CICD.outputs.deployed_env == 'prod'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Create release tag
        if: startsWith(github.ref, 'refs/heads/')  # Only for workflow_dispatch, not tag push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.CICD.outputs.release_version }}"
          TAG="v${VERSION%%+*}"  # Strip +sha suffix for tag
          # Check if tag already exists
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "â­ï¸ Tag $TAG already exists, skipping"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
            echo "âœ… Created tag $TAG"
          fi
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.CICD.outputs.release_version }}"
          TAG="v${VERSION%%+*}"
          # Check if release already exists
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "â­ï¸ Release $TAG already exists, skipping"
          else
            gh release create "$TAG" \
              --title "Release $TAG" \
              --notes "**Deployed:** ${{ needs.CICD.outputs.release_date }}

          **Environment:** production
          **URL:** ${{ needs.CICD.outputs.deployed_url }}
          **Commit:** ${{ github.sha }}

          Full version: \`$VERSION\`"
            echo "âœ… Created release $TAG"
          fi

  rollback:
    needs: CICD
    if: github.event_name == 'workflow_dispatch' && inputs.rollback_to != ''
    runs-on: ubuntu-latest
    steps:
      - name: Rollback summary
        run: |
          echo "## â®ï¸ Rollback Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Rolled back to commit: \`${{ inputs.rollback_to }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Version: \`${{ needs.CICD.outputs.release_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Deployed to: ${{ needs.CICD.outputs.deployed_url }}" >> $GITHUB_STEP_SUMMARY

  smoke-tests:
    needs: CICD
    if: needs.CICD.outputs.deployed_url != ''
    runs-on: ubuntu-latest
    environment: ${{ needs.CICD.outputs.deployed_env }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v5
        with:
          node-version-file: 'package.json'
      - run: npm ci
      - name: Install Playwright
        run: npx playwright install chromium
      - name: Run smoke tests
        env:
          BASE_URL: ${{ vars.BASE_URL }}
          HEY_NABO_USERNAME: ${{ secrets.HEY_NABO_USERNAME }}
          HEY_NABO_PASSWORD: ${{ secrets.HEY_NABO_PASSWORD }}
          HEY_NABO_EJ_ADMIN_USERNAME: ${{ secrets.HEY_NABO_EJ_ADMIN_USERNAME }}
          CLOUDFLARE_BYPASS_TOKEN: ${{ secrets.CLOUDFLARE_BYPASS_TOKEN }}
          SHOULD_NOT_MUTATE: true
          EXPECTED_VERSION: ${{ needs.CICD.outputs.release_version }}
        run: npm run test:e2e:smoke
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-smoke
          path: playwright-report/
          retention-days: 30
      - name: Summary
        run: |
          echo "## âœ… Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "Verified: ${{ needs.CICD.outputs.deployed_url }}" >> $GITHUB_STEP_SUMMARY
          echo "Version: \`${{ needs.CICD.outputs.release_version }}\`" >> $GITHUB_STEP_SUMMARY
