name: The CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  CICD:
    runs-on: ubuntu-latest
    environment: CLOUDFLARE_THESLOPE
    outputs:
      deployed_env: ${{ steps.target.outputs.env }}
      deployed_url: ${{ steps.deploy.outputs.url }}

    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      HEY_NABO_USERNAME: ${{ secrets.HEY_NABO_USERNAME }}
      HEY_NABO_PASSWORD: ${{ secrets.HEY_NABO_PASSWORD }}
      HEY_NABO_EJ_ADMIN_USERNAME: ${{ secrets.HEY_NABO_EJ_ADMIN_USERNAME }}
      NUXT_PUBLIC_HEY_NABO_API: ${{ vars.NUXT_PUBLIC_HEY_NABO_API }}
      DB_D1_NAME: ${{ vars.DB_D1_NAME }}
      DB_D1_ID: ${{ secrets.DB_D1_ID }}
      NUXT_SESSION_PASSWORD: ${{ secrets.NUXT_SESSION_PASSWORD }}
      CI: true

    steps:
      - uses: actions/checkout@v4
      - run: ls -la
      - uses: actions/setup-node@v5
        with:
          node-version-file: 'package.json'
      - run: npm ci
      - name: Linting
        run: npm run lint
      - run: npx prisma validate
      - name: Run unit tests
        run: npm run test:unit
      - name: Install Playwright and browser friends
        run: npx playwright install chromium
      - name: Prepare local D1 database for testing
        run: |
          npm run db:migrate:local
          npm run db:seed:local
          npx wrangler d1 execute theslope --command="SELECT * FROM User" --local
      - name: Run e2e api tests
        run: npm run test:e2e:api
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-api
          path: playwright-report/
          retention-days: 30
      - name: Run e2e ui tests
        run: npm run test:e2e:ui
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-ui
          path: playwright-report/
          retention-days: 30
      - name: Determine deployment target
        id: target
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "env=prod" >> $GITHUB_OUTPUT
          else
            echo "env=dev" >> $GITHUB_OUTPUT
          fi
      - name: Deploy to Cloudflare
        id: deploy
        run: |
          if [ "${{ steps.target.outputs.env }}" == "prod" ]; then
            OUTPUT=$(npm run deploy:prod 2>&1)
          else
            OUTPUT=$(npm run deploy 2>&1)
          fi
          echo "$OUTPUT"
          echo "url=$(echo "$OUTPUT" | grep 'DEPLOY_URL' | grep -oE 'https://[^")]+')" >> $GITHUB_OUTPUT
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployed to ${{ steps.target.outputs.env }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`${{ steps.target.outputs.env }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | ${{ steps.deploy.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit Message** | ${{ github.event.head_commit.message }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **PR Title** | ${{ github.event.pull_request.title }} |" >> $GITHUB_STEP_SUMMARY

  smoke-tests:
    needs: CICD
    if: needs.CICD.outputs.deployed_url != ''
    runs-on: ubuntu-latest
    environment: ${{ needs.CICD.outputs.deployed_env }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v5
        with:
          node-version-file: 'package.json'
      - run: npm ci
      - name: Install Playwright
        run: npx playwright install chromium
      - name: Run smoke tests
        env:
          BASE_URL: ${{ vars.BASE_URL }}
          HEY_NABO_USERNAME: ${{ secrets.HEY_NABO_USERNAME }}
          HEY_NABO_PASSWORD: ${{ secrets.HEY_NABO_PASSWORD }}
          HEY_NABO_EJ_ADMIN_USERNAME: ${{ secrets.HEY_NABO_EJ_ADMIN_USERNAME }}
          CLOUDFLARE_BYPASS_TOKEN: ${{ secrets.CLOUDFLARE_BYPASS_TOKEN }}
          SHOULD_NOT_MUTATE: true
          EXPECTED_VERSION: ${{ github.sha }}
        run: npm run test:e2e:smoke
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-smoke
          path: playwright-report/
          retention-days: 30
      - name: Summary
        run: |
          echo "## âœ… Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "Verified: ${{ needs.CICD.outputs.deployed_url }}" >> $GITHUB_STEP_SUMMARY
