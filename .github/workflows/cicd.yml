name: The CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  CICD:
    runs-on: ubuntu-latest
    environment: CLOUDFLARE_THESLOPE
    outputs:
      deployed_env: ${{ steps.deploy-info.outputs.env }}

    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      HEY_NABO_USERNAME: ${{ secrets.HEY_NABO_USERNAME }}
      HEY_NABO_PASSWORD: ${{ secrets.HEY_NABO_PASSWORD }}
      NUXT_PUBLIC_HEY_NABO_API: ${{ vars.NUXT_PUBLIC_HEY_NABO_API }}
      DB_D1_NAME: ${{ vars.DB_D1_NAME }}
      DB_D1_ID: ${{ secrets.DB_D1_ID }}
      NUXT_SESSION_PASSWORD: ${{ secrets.NUXT_SESSION_PASSWORD }}
      CI: true

    steps:
      - uses: actions/checkout@v4
      - run: ls -la
      - uses: actions/setup-node@v5
        with:
          node-version-file: 'package.json'
      - run: npm ci
      - name: Linting
        run: npm run lint
      - run: npx prisma validate
      - name: Run unit tests
        run: npm run test:unit
      - name: Install Playwright and browser friends
        run: npx playwright install chromium
      - name: Prepare local D1 database for testing
        run: |
          npm run db:migrate:local
          npm run db:seed:local
          npx wrangler d1 execute theslope --command="SELECT * FROM User" --local
      - name: Run e2e api tests
        run: npm run test:e2e:api
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-api
          path: playwright-report/
          retention-days: 30
      - name: Run e2e ui tests
        run: npm run test:e2e:ui
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-ui
          path: playwright-report/
          retention-days: 30
      - name: Deploy to dev server on Cloudflare ðŸ˜Ž
        id: deploy-dev
        if: github.ref != 'refs/heads/main'
        run: npm run deploy
      - name: Summary - Dev deployment
        if: github.ref != 'refs/heads/main'
        run: |
          echo "## ðŸš€ Deployed to DEV" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`dev\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit Message** | ${{ github.event.head_commit.message }} |" >> $GITHUB_STEP_SUMMARY
      - name: Deploy to production server on Cloudflare ðŸš€
        id: deploy-prod
        if: github.ref == 'refs/heads/main'
        run: npm run deploy:prod
      - name: Summary - Production deployment
        if: github.ref == 'refs/heads/main'
        run: |
          echo "## ðŸš€ Deployed to PRODUCTION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`prod\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit Message** | ${{ github.event.head_commit.message }} |" >> $GITHUB_STEP_SUMMARY
